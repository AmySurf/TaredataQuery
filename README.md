# TaredataQuery
SQL for daily work filling

### Ship###
SELECT  
T1.GREGORIAN_DATE,
T2.OLD_NBR,
T2.CATEGORY_NBR,
T1.STORE_NBR,

SUM(CASE
WHEN T3.DAY_OF_WK=1 THEN T1.SAT_QTY
WHEN T3.DAY_OF_WK=2 THEN T1.SUN_QTY
WHEN T3.DAY_OF_WK=3 THEN T1.MON_QTY
WHEN T3.DAY_OF_WK=4 THEN T1.TUE_QTY
WHEN T3.DAY_OF_WK=5 THEN T1.WED_QTY
WHEN T3.DAY_OF_WK=6 THEN T1.THU_QTY
WHEN T3.DAY_OF_WK=7 THEN T1.FRI_QTY
END) AS SHIP_QTY,
SUM(CASE
WHEN T3.DAY_OF_WK=1 THEN T1.SAT_QTY*T1.SHIP_COST
WHEN T3.DAY_OF_WK=2 THEN T1.SUN_QTY*T1.SHIP_COST
WHEN T3.DAY_OF_WK=3 THEN T1.MON_QTY*T1.SHIP_COST
WHEN T3.DAY_OF_WK=4 THEN T1.TUE_QTY*T1.SHIP_COST
WHEN T3.DAY_OF_WK=5 THEN T1.WED_QTY*T1.SHIP_COST
WHEN T3.DAY_OF_WK=6 THEN T1.THU_QTY*T1.SHIP_COST
WHEN T3.DAY_OF_WK=7 THEN T1.FRI_QTY*T1.SHIP_COST
END )AS SHIP_COST,
SUM(CASE
WHEN T3.DAY_OF_WK=1 THEN T1.SAT_QTY*T1.sell_price
WHEN T3.DAY_OF_WK=2 THEN T1.SUN_QTY*T1.sell_price
WHEN T3.DAY_OF_WK=3 THEN T1.MON_QTY*T1.sell_price
WHEN T3.DAY_OF_WK=4 THEN T1.TUE_QTY*T1.sell_price
WHEN T3.DAY_OF_WK=5 THEN T1.WED_QTY*T1.sell_price
WHEN T3.DAY_OF_WK=6 THEN T1.THU_QTY*T1.sell_price
WHEN T3.DAY_OF_WK=7 THEN T1.FRI_QTY*T1.sell_price
END )AS SHIP_retail

FROM     CN_WC_VM.WEEKLY_STORE_SHIPS T1, CN_WC_VM.ITEM_DESC_ASCII T2, CN_WC_VM.CALENDAR_DAY T3

WHERE   T3.GREGORIAN_DATE BETWEEN DATE'2021-11-01' AND DATE '2021-11-30'
    AND T1.STORE_NBR NOT IN (6660,6661,6662,6663,6664,6665,6667,6668)
   AND T2. CATEGORY_NBR IN (56,57,39,77,48,72,79,76,91,75,86,42,44)

   AND T1.ITEM_NBR=T2.ITEM_NBR AND T1.WM_YR_WK=T3.WM_YR_WK

GROUP   BY 1,2,3,4,5
WHEN T1.DAY_OF_WK=1 THEN T2.SAT_QTY
WHEN T1.DAY_OF_WK=2 THEN T2.SUN_QTY
WHEN T1.DAY_OF_WK=3 THEN T2.MON_QTY
WHEN T1.DAY_OF_WK=4 THEN T2.TUE_QTY
WHEN T1.DAY_OF_WK=5 THEN T2.WED_QTY
WHEN T1.DAY_OF_WK=6 THEN T2.THU_QTY
WHEN T1.DAY_OF_WK=7 THEN T2.FRI_QTY
END )>0
 FROM CN_ODS_ALOHA_ORDER.O_BAS_ORDER_INFO_D T1
 LEFT JOIN CN_ODS_ALOHA_ORDER.O_BAS_ORDER_DETAIL_D T2 
 ON T1.ORDER_ID = T2.ORDER_ID
 WHERE  TO_DATE(T1.TRANS_DATE)  BETWEEN '2021-11-26' AND '2021-11-30'
 AND  DATEDIFF(CURRENT_DATE,T1.TS)<=90
 --DATEDIFF(CURRENT_DATE, T1.TRANS_DATE) <= 7
 AND T1.CHANNEL_ID IN (33, 30, 24) 
 AND T1.ORDER_STATUS = 430 
 AND T1.TC_NUMBER IS NOT NULL
 AND T1.PICK_STORE_ID IS NOT NULL
 AND T2.DEPARTMENT IN (39,56,57,48,72,77,75,76,86,91,42,44)
 GROUP BY T2.ITEM_ID,T1.STORE_ID, T2.DEPARTMENT,TO_DATE(T1.TRANS_DATE)) T2 
 ON T1.STOCKADJUSTDATE=T2.SALE_DATE  AND T1.ITEM_NBR=T2.ITEM_NBR AND T1.CLUB=T2.CLUB 





SELECT
T1.STORE_NBR,
--T2.VISIT_DATE,
 T4.OLD_NBR,
 T4.PRIMARY_DESC,
 T4.SUB_CATEGORY_NBR,
 T4.CATEGORY_NBR,
    --T4.VENDOR_NBR||T4.VENDOR_NBR_DEPT||T4.VENDOR_NBR_SEQ AS QVENDOR_NBR,
    --T4.VENDOR_NAME,
--EXTRACT (YEAR FROM T2.VISIT_DATE) AS YR,
 --EXTRACT (MONTH FROM T2.VISIT_DATE) AS MOS,
 
 CASE WHEN T4.CATEGORY_NBR IN (56,57,39,77,48,72,79,76,66,96,91,75,86,42,44) THEN 'FR'
WHEN T4.CATEGORY_NBR IN (1,53,58,51,43,49,45,46,36,41,35,40,52) THEN 'DG'
WHEN T4.CATEGORY_NBR IN (16,28,80,19,55) THEN 'LIQUOR'
WHEN T4.CATEGORY_NBR IN (47,7,2,24,54,13,8,94,59,88) THEN 'CS'
WHEN T4.CATEGORY_NBR IN (23,33,22,95,68,21,14,17,18,32,9,10,11,93) THEN 'H&A'
WHEN T4.CATEGORY_NBR IN (6,61,31,3,70,5,12,20,81,15,83) THEN 'TEO'
ELSE T4.CATEGORY_NBR
END AS DIVISION,

 MONTH(T2.VISIT_DATE) AS MOH,
SUM(t3.retail_Price) AS Sales,
SUM(t3.unit_qty * t3.unit_cost) AS Cost,
SUM(t3.Unit_qty) AS QTY,
COUNT(DISTINCT  (T2.visit_nbr || t3.store_nbr) ) AS Trans,
COUNT(DISTINCT  (T2.MEMBERSHIP_NBR) ) AS MBRCNT

    FROM        CN_WC_MB_VM.VISIT_MEMBER T2   -- 4ꐅϢ
    LEFT JOIN       CN_WC_MB_VM.VISIT T1  --ᔱЅϢ
           ON T1.VISIT_DATE=T2.VISIT_DATE 
           AND T1.STORE_NBR = T2.STORE_NBR 
           AND     T1.VISIT_NBR=T2.VISIT_NBR
    LEFT JOIN CN_WC_MB_VM.SCAN T3 --ЅϢ
           ON T3.STORE_NBR = T2.STORE_NBR 
           AND T3.VISIT_DATE=T2.VISIT_DATE
           AND     T3.VISIT_NBR=T2.VISIT_NBR
    LEFT JOIN CN_WC_VM.ITEM_DESC_ASCII T4 --ɌƷ÷ϸ
           ON T3.SCAN_ID = T4. ITEM_NBR
    LEFT JOIN CN_WC_VM.SAMS_MEMBER_INDEX T5 --ᔱЅϢ2
      ON T2.MEMBERSHIP_NBR=T5.MEMBERSHIP_NBR


    WHERE T2.VISIT_DATE BETWEEN DATE  '2022-01-01' AND  DATE '2022-01-31' 
    --AND T4.SUB_CATEGORY_NBR IN (64)
    --AND T4.CATEGORY_NBR IN (42) 
    --AND T4.OLD_NBR IN (980092772) 
    AND T3.STORE_NBR  NOT IN (6660,6661,6662,6663,6664,6665,6667,6668)



--SELECT TOP 5					
SELECT 					
					
TABT.OLD_NBR,					
TABT.PRIMARY_DESC,					
TABT.SUB_CATEGORY_NBR,					
TABT.CATEGORY_NBR,					
 					
TABT.STORE, 					
TABT.TDATE,					
--TABT.CAT,					
--MONTH(TABT.TDATE) AS Mon,					
--YEAR    (TABT.TDATE) AS Yr,					
SUM(TABT.QTY) AS QTY,					
SUM(TABT.TTL_COST) AS ITEM_COST,					
SUM(TABT.TTL_SALES) AS ITEM_SELL					
FROM 					
(SELECT 					
TAB2.CLUB_NBR AS STORE,					
TAB3.VISIT_DATE AS TDATE,					
tab1.OLD_NBR,					
tab1.PRIMARY_DESC,					
tab1.SUB_CATEGORY_NBR,					
tab1.CATEGORY_NBR,					
SUM(TTL_QTY) AS QTY,					
SUM(TAB2.VENDOR_PACK_COST/tab1.VNPK_QTY) *					
ZEROIFNULL(SUM(TTL_QTY)) AS TTL_COST,					
ZEROIFNULL(SUM(TTL_SALES)) AS TTL_SALES					
FROM					
CN_WC_VM.ITEM_DESC_ASCII tab1 					
INNER JOIN					
CN_WC_VM.MDSE_INVENTORY tab2  ON  tab1.ITEM_NBR=tab2.ITEM_NBR					
LEFT JOIN					
(SELECT 					
T1.ITEM_NBR,					
T1.OLD_NBR,					
T2.STORE_NBR,					
T2.VISIT_DATE ,					
SUM(T2.UNIT_QTY) AS TTL_QTY,					
SUM(t2.RETAIL_PRICE) AS TTL_SALES					
FROM 					
CN_WC_VM.ITEM_DESC_ASCII T1,					
CN_WC_MB_VM.SCAN  T2					
WHERE 					
T1.ITEM_NBR=T2.SCAN_ID 					
--AND T2.VISIT_DATE BETWEEN DATE - 8 AND DATE					
AND T2.VISIT_DATE  BETWEEN DATE  '2021-12-01' AND  DATE '2021-12-12' 					
--AND T2.VISIT_DATE = DATE'2017-03-12' 					
--AND T2.STORE_NBR=4829					
GROUP BY 1,2,3,4)TAB3 ON   tab2.ITEM_NBR= tab3.ITEM_NBR AND  tab2.CLUB_NBR= tab3.STORE_NBR					
WHERE					
tab2.CLUB_NBR NOT IN (4874,4873,4802,4920,4819,1060,1063,4875,6660,6661,6662,6663,6664,6665,6667,6668)					
--AND tab1.category_nbr  IN (56,57,39,77,48,72,79,76,91,75,86,42,44,38)					
AND tab1.category_nbr IN (77,72,79,76,75)					
AND ttl_sales > 0					
GROUP BY 1,2,3,4,5,6) TABT					
GROUP BY 1,2,3,4,5,6					
